#!/usr/bin/env node

require('babel/register');

const cluster = require('cluster');
const cpus = require('os').cpus();
const app = require('app.js');
const sitemap = require('express-sitemap')({ url: 'kindlize.it' });

const IS_PRODUCTION = process.env.NODE_ENV === 'production';

function forkWorker() {
  const worker = cluster.fork();
  worker.send({ workerId: worker.id });
}

function startServer() {
  app.set('port', process.env.PORT || 3000);
  sitemap.generate4(app, [
    '/',
    '/account/',
    '/author/',
  ]);
  sitemap.XMLtoFile('./public/sitemap.xml');

  app.listen(app.get('port'));
  process.on('message', (msg)=> {
    if (msg.workerId) {
      console.log(`Server listening with worker-id ${msg.workerId}`);
    }
  });
}

function main() {
  if (IS_PRODUCTION && cluster.isMaster) {
    cluster.on('exit', (worker, code, signal) => {
      console.log(`Worker ${worker.id} died with code ${signal || code}.\nRestarting...`);
      forkWorker();
    });

    return cpus.forEach(forkWorker);
  }
  startServer();
}

main();
